<!DOCTYPE html>
<html>
<head>
  <title>Druckmonitor</title>
  <meta charset="UTF-8">
</head>
<body>
  <h1>üñ®Ô∏è Druckbereit</h1>
  <div id="status">Warte auf neue Bestellung ...</div>

  <script>
    const DRUCKER_IP = 'http://192.168.0.100'; // IP deines Epson TM-m30
    const POLL_URL = 'https://DEIN-RENDER-URL/latest-order';

    async function pollAndPrint() {
      try {
        const res = await fetch(POLL_URL);
        if (res.status === 204) return;

        const order = await res.json();
        document.getElementById('status').textContent = `Drucke ${order.name}...`;

        const xml = `<epos-print>
          <text align='center'>üå∏ Classic Floral</text>
          <text>Bestellung: ${order.name}</text>
          ${order.line_items.map(i => `<text>${i.quantity}√ó ${i.title}</text>`).join('')}
          <text>Gesamt: ${order.total_price} ‚Ç¨</text>
          <cut />
        </epos-print>`;

        await fetch(`${DRUCKER_IP}/cgi-bin/epos/service.cgi?devid=local_printer&timeout=10000`, {
          method: 'POST',
          headers: { 'Content-Type': 'text/xml' },
          body: xml
        });

        document.getElementById('status').textContent = `Gedruckt: ${order.name}`;
      } catch (err) {
        console.error('Fehler beim Drucken:', err);
        document.getElementById('status').textContent = 'Fehler beim Drucken';
      }
    }

    setInterval(pollAndPrint, 5000);
  </script>
</body>
</html>
